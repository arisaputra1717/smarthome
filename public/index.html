<!DOCTYPE html>
<html lang="id">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Smart Home Control Panel</title>
Â  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
Â  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
Â  <div class="container mx-auto p-6">
Â  Â  <h1 class="text-3xl font-bold mb-6 text-center text-blue-800">Smart Home Control Panel</h1>

Â  Â  Â  Â  <div class="mb-6 text-center bg-white p-4 rounded-lg shadow-md">
Â  Â  Â  <label for="mac-select" class="font-semibold mr-2 text-lg">Pilih Perangkat:</label>
Â  Â  Â  <select id="mac-select" class="px-4 py-2 border rounded-lg text-lg min-w-64">
Â  Â  Â  Â  <option value="">-- Pilih MAC Address --</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  Â  Â  <div id="relay-panel" class="mb-6 bg-white p-6 rounded-lg shadow-md hidden">
Â  Â  Â  <h2 class="text-xl font-bold mb-4 text-center text-green-700">Kontrol Relay</h2>
Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="text-center mb-4">
Â  Â  Â  Â  <span class="text-lg font-semibold">Status: </span>
Â  Â  Â  Â  <span id="relay-status" class="px-3 py-1 rounded-full text-white font-bold">UNKNOWN</span>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="flex justify-center space-x-4 mb-4">
Â  Â  Â  Â  <button id="btn-on" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition transform hover:scale-105">
Â  Â  Â  Â  Â  ğŸ”Œ NYALAKAN
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button id="btn-off" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition transform hover:scale-105">
Â  Â  Â  Â  Â  ğŸ”Œ MATIKAN
Â  Â  Â  Â  </button>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-6">
Â  Â  Â  Â  <h3 class="text-lg font-semibold mb-3 text-gray-700">Riwayat Status Relay (dari Perangkat)</h3>
Â  Â  Â  Â  <div class="max-h-40 overflow-y-auto">
Â  Â  Â  Â  Â  <table class="w-full text-sm">
Â  Â  Â  Â  Â  Â  <thead class="bg-gray-200">
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="py-2 px-3 text-left">Waktu</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="py-2 px-3 text-left">Status</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="relay-history" class="divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="statistics-filter-panel" class="mb-6 bg-white p-4 rounded-lg shadow-md hidden">
Â  Â  Â  <h3 class="text-lg font-semibold mb-4 text-gray-700">Filter Tanggal untuk Statistik</h3>
Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai:</label>
Â  Â  Â  Â  Â  <input type="date" id="start-date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir:</label>
Â  Â  Â  Â  Â  <input type="date" id="end-date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <button id="btn-apply-statistics-filter" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
Â  Â  Â  Â  Â  Â  ğŸ” Terapkan Filter
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <button id="btn-clear-statistics-filter" class="w-full px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">
Â  Â  Â  Â  Â  Â  ğŸ—‘ Reset Filter
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="statistics-panel" class="mb-6 bg-white p-6 rounded-lg shadow-md hidden">
Â  Â  Â  <h3 class="text-lg font-semibold mb-4 text-gray-700">Statistik Konsumsi Energi</h3>
Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
Â  Â  Â  Â  <div class="bg-blue-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-blue-800">Tegangan Rata-rata</h4>
Â  Â  Â  Â  Â  <p id="stat-voltage" class="text-2xl font-bold text-blue-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-green-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-green-800">Arus Rata-rata</h4>
Â  Â  Â  Â  Â  <p id="stat-current" class="text-2xl font-bold text-green-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-yellow-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-yellow-800">Daya Rata-rata</h4>
Â  Â  Â  Â  Â  <p id="stat-power" class="text-2xl font-bold text-yellow-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-purple-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-purple-800">Total Daya</h4>
Â  Â  Â  Â  Â  <p id="stat-total-power" class="text-2xl font-bold text-purple-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-red-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-red-800">Konsumsi KWh</h4>
Â  Â  Â  Â  Â  <p id="stat-consumption" class="text-2xl font-bold text-red-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-gray-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-gray-800">Total Record</h4>
Â  Â  Â  Â  Â  <p id="stat-records" class="text-2xl font-bold text-gray-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="text-center mb-6 flex flex-wrap justify-center gap-4">
Â  Â  Â  <button id="btn-show-statistics" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
Â  Â  Â  Â  ğŸ“Š Tampilkan Statistik
Â  Â  Â  </button>
Â  Â  Â  <button id="btn-hide-statistics" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition hidden">
Â  Â  Â  Â  â—€ Sembunyikan Statistik
Â  Â  Â  </button>
Â  Â  Â  <button onclick="if(confirm('Yakin ingin menghapus semua data energi?')) window.location.href='/api/reset-data'" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">
Â  Â  Â  Â  ğŸ—‘ Reset Data Energi
Â  Â  Â  </button>
Â  Â  Â  <button id="btn-reset-relay" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition">
Â  Â  Â  Â  ğŸ—‘ Reset Data Relay
Â  Â  Â  </button>
Â  Â  Â  <button id="btn-export-csv" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
Â  Â  Â  Â  ğŸ“„ Export CSV Data Terbaru
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  Â  Â  <div class="mb-4 bg-blue-50 p-3 rounded-lg">
Â  Â  Â  <div class="flex flex-wrap justify-between items-center text-sm text-blue-800">
Â  Â  Â  Â  <span id="data-info"></span>
Â  Â  Â  Â  <span id="total-records" class="font-semibold"></span>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="latest-data-table-container" class="bg-white rounded-lg shadow-md overflow-hidden">
Â  Â  Â  <h2 class="text-xl font-bold p-4 bg-blue-600 text-white">Data Konsumsi Energi Terbaru</h2>
Â  Â  Â  <div class="overflow-x-auto">
Â  Â  Â  Â  <table class="min-w-full">
Â  Â  Â  Â  Â  <thead class="bg-blue-500 text-white">
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">ID</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Tanggal</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Waktu</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Tegangan (V)</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Arus (A)</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Daya (W)</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">KWh</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">MAC Address</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Status Relay</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">MQTT Topic</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="data-table" class="divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="loading" class="hidden fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg">
Â  Â  Â  Memproses...
Â  Â  </div>
Â  Â  
Â  Â  <div id="notification" class="hidden fixed top-4 right-4 px-4 py-2 rounded-lg text-white font-semibold">
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // App state
Â  Â  const state = {
Â  Â  Â  selectedMac: '',
Â  Â  Â  currentLatestData: null, // Stores only the single latest data record
Â  Â  Â  isLoading: false,
Â  Â  Â  isStatisticsView: false, // New state to track if statistics panel is open
Â  Â  Â  intervals: {
Â  Â  Â  Â  dataRefresh: null,
Â  Â  Â  Â  relayRefresh: null
Â  Â  Â  }
Â  Â  };

Â  Â  // DOM elements
Â  Â  const elements = {
Â  Â  Â  macSelect: document.getElementById('mac-select'),
Â  Â  Â  latestDataTableBody: document.getElementById('data-table'),
Â  Â  Â  latestDataTableContainer: document.getElementById('latest-data-table-container'),
Â  Â  Â  relayPanel: document.getElementById('relay-panel'),
Â  Â  Â  relayStatus: document.getElementById('relay-status'),
Â  Â  Â  btnOn: document.getElementById('btn-on'),
Â  Â  Â  btnOff: document.getElementById('btn-off'),
Â  Â  Â  relayHistory: document.getElementById('relay-history'),
Â  Â  Â  btnResetRelay: document.getElementById('btn-reset-relay'),
Â  Â  Â  loading: document.getElementById('loading'),
Â  Â  Â  notification: document.getElementById('notification'),
Â  Â  Â  statisticsPanel: document.getElementById('statistics-panel'),
Â  Â  Â  startDate: document.getElementById('start-date'),
Â  Â  Â  endDate: document.getElementById('end-date'),
Â  Â  Â  btnApplyStatisticsFilter: document.getElementById('btn-apply-statistics-filter'), // Renamed
Â  Â  Â  btnClearStatisticsFilter: document.getElementById('btn-clear-statistics-filter'), // Renamed
Â  Â  Â  btnExportCsv: document.getElementById('btn-export-csv'),
Â  Â  Â  btnShowStatistics: document.getElementById('btn-show-statistics'), // Renamed
Â  Â  Â  btnHideStatistics: document.getElementById('btn-hide-statistics'), // New button
Â  Â  Â  dataInfo: document.getElementById('data-info'),
Â  Â  Â  totalRecords: document.getElementById('total-records'),
Â  Â  Â  statisticsFilterPanel: document.getElementById('statistics-filter-panel') // New element
Â  Â  };

Â  Â  // Set default dates (last 7 days for statistics filter)
Â  Â  function setDefaultDatesForStatistics() {
Â  Â  Â  const today = new Date();
Â  Â  Â  const weekAgo = new Date(today);
Â  Â  Â  weekAgo.setDate(today.getDate() - 7);
Â  Â  Â  
Â  Â  Â  elements.endDate.value = today.toISOString().split('T')[0];
Â  Â  Â  elements.startDate.value = weekAgo.toISOString().split('T')[0];
Â  Â  }

Â  Â  // Utility functions
Â  Â  function showNotification(message, type = 'success') {
Â  Â  Â  elements.notification.textContent = message;
Â  Â  Â  elements.notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white font-semibold ${
Â  Â  Â  Â  type === 'success' ? 'bg-green-600' : 'bg-red-600'
Â  Â  Â  }`;
Â  Â  Â  elements.notification.classList.remove('hidden');
Â  Â  Â  
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  elements.notification.classList.add('hidden');
Â  Â  Â  }, 3000);
Â  Â  }

Â  Â  function showLoading() {
Â  Â  Â  if (state.isLoading) return;
Â  Â  Â  state.isLoading = true;
Â  Â  Â  elements.loading.classList.remove('hidden');
Â  Â  }

Â  Â  function hideLoading() {
Â  Â  Â  state.isLoading = false;
Â  Â  Â  elements.loading.classList.add('hidden');
Â  Â  }

Â  Â  function debounce(func, wait) {
Â  Â  Â  let timeout;
Â  Â  Â  return function executedFunction(...args) {
Â  Â  Â  Â  const later = () => {
Â  Â  Â  Â  Â  clearTimeout(timeout);
Â  Â  Â  Â  Â  func(...args);
Â  Â  Â  Â  };
Â  Â  Â  Â  clearTimeout(timeout);
Â  Â  Â  Â  timeout = setTimeout(later, wait);
Â  Â  Â  };
Â  Â  }

Â  Â  // Clear all intervals
Â  Â  function clearAllIntervals() {
Â  Â  Â  Object.values(state.intervals).forEach(interval => {
Â  Â  Â  Â  if (interval) clearInterval(interval);
Â  Â  Â  });
Â  Â  Â  state.intervals = { dataRefresh: null, relayRefresh: null };
Â  Â  }

Â  Â  // Update info data based on current view
Â  Â  function updateDataInfo() {
Â  Â  Â  if (state.isStatisticsView) {
Â  Â  Â  Â  const startDateVal = elements.startDate.value;
Â  Â  Â  Â  const endDateVal = elements.endDate.value;
Â  Â  Â  Â  elements.dataInfo.textContent = `Statistik dari ${startDateVal} sampai ${endDateVal}`;
Â  Â  Â  Â  // Total records for statistics will be updated by fetchStatistics
Â  Â  Â  Â  elements.totalRecords.textContent = ''; 
Â  Â  Â  } else {
Â  Â  Â  Â  elements.dataInfo.textContent = 'Menampilkan data terbaru';
Â  Â  Â  Â  elements.totalRecords.textContent = state.currentLatestData ? 'Total: 1 record (terbaru)' : 'Total: 0 record';
Â  Â  Â  }
Â  Â  }

Â  Â  // API calls with error handling
Â  Â  async function apiCall(url, options = {}) {
Â  Â  Â  try {
Â  Â  Â  Â  const response = await axios({
Â  Â  Â  Â  Â  url,
Â  Â  Â  Â  Â  timeout: 10000,
Â  Â  Â  Â  Â  ...options
Â  Â  Â  Â  });
Â  Â  Â  Â  return response.data;
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('API Error:', error);
Â  Â  Â  Â  throw error;
Â  Â  Â  }
Â  Â  }

Â  Â  // Fetch MAC list
Â  Â  async function fetchMacList() {
Â  Â  Â  try {
Â  Â  Â  Â  const macs = await apiCall('/api/mac-list');
Â  Â  Â  Â  elements.macSelect.innerHTML = '<option value="">-- Pilih MAC Address --</option>';
Â  Â  Â  Â  macs.forEach(mac => {
Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  option.value = mac.mac_address;
Â  Â  Â  Â  Â  option.textContent = `ğŸ“± ${mac.mac_address}`;
Â  Â  Â  Â  Â  elements.macSelect.appendChild(option);
Â  Â  Â  Â  });
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showNotification('Gagal mengambil daftar perangkat', 'error');
Â  Â  Â  }
Â  Â  }

Â  Â  // Render a single data row (for latest data)
Â  Â  function renderSingleDataRow(data, targetTableBody) {
Â  Â  Â  targetTableBody.innerHTML = '';
Â  Â  Â  if (!data) {
Â  Â  Â  Â  targetTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data</td></tr>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  tr.className = "hover:bg-gray-50";
Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  <td class="py-2 px-4">${data.id || '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4">${data.tanggal || '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4">${data.waktu || '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4">${data.tegangan ? data.tegangan.toFixed(2) + ' V' : '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4">${data.arus ? data.arus.toFixed(3) + ' A' : '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4">${data.daya ? data.daya.toFixed(2) + ' W' : '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4">${data.kwh ? data.kwh.toFixed(4) + ' kWh' : '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4 font-mono text-sm">${data.mac_address || '-'}</td>
Â  Â  Â  Â  <td class="py-2 px-4">
Â  Â  Â  Â  Â  ${data.relay_status ? `<span class="px-2 py-1 rounded text-xs font-bold ${
Â  Â  Â  Â  Â  Â  data.relay_status === 'ON' ? 'bg-green-100 text-green-800' : 
Â  Â  Â  Â  Â  Â  data.relay_status === 'OFF' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
Â  Â  Â  Â  Â  }">${data.relay_status}</span>` : '-'}
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td class="py-2 px-4 font-mono text-xs">${data.mqtt_topic || '-'}</td>
Â  Â  Â  `;
Â  Â  Â  targetTableBody.appendChild(tr);
Â  Â  }

Â  Â  // Fetch latest data (primary display)
Â  Â  const fetchLatestData = debounce(async function() {
Â  Â  Â  if (!state.selectedMac || state.isLoading) return;

Â  Â  Â  showLoading();
Â  Â  Â  try {
Â  Â  Â  Â  const data = await apiCall('/api/latest-data?mac=' + encodeURIComponent(state.selectedMac));
Â  Â  Â  Â  state.currentLatestData = data;
Â  Â  Â  Â  renderSingleDataRow(data, elements.latestDataTableBody);
Â  Â  Â  Â  updateDataInfo();
Â  Â  Â  Â  showNotification('Data terbaru berhasil dimuat');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showNotification('Gagal mengambil data terbaru', 'error');
Â  Â  Â  Â  elements.latestDataTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data terbaru</td></tr>';
Â  Â  Â  Â  state.currentLatestData = null;
Â  Â  Â  Â  updateDataInfo();
Â  Â  Â  } finally {
Â  Â  Â  Â  hideLoading();
Â  Â  Â  }
Â  Â  }, 500); // Debounce to prevent rapid calls

Â  Â  // Fetch statistics
Â  Â  async function fetchStatistics() {
Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  let url = '/api/statistics?mac=' + encodeURIComponent(state.selectedMac);
Â  Â  Â  
Â  Â  Â  if (elements.startDate.value && elements.endDate.value) {
Â  Â  Â  Â  url += `&start_date=${elements.startDate.value}&end_date=${elements.endDate.value}`;
Â  Â  Â  }

Â  Â  Â  showLoading();
Â  Â  Â  try {
Â  Â  Â  Â  const data = await apiCall(url);
Â  Â  Â  Â  const stats = data.statistics;
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('stat-voltage').textContent = `${stats.average_voltage !== null ? stats.average_voltage.toFixed(2) + ' V' : '-'}`;
Â  Â  Â  Â  document.getElementById('stat-current').textContent = `${stats.average_current !== null ? stats.average_current.toFixed(3) + ' A' : '-'}`;
Â  Â  Â  Â  document.getElementById('stat-power').textContent = `${stats.average_power !== null ? stats.average_power.toFixed(2) + ' W' : '-'}`;
Â  Â  Â  Â  document.getElementById('stat-total-power').textContent = `${stats.total_power !== null ? stats.total_power.toFixed(2) + ' W' : '-'}`;
Â  Â  Â  Â  document.getElementById('stat-consumption').textContent = `${stats.energy_range.consumption_kwh !== null ? stats.energy_range.consumption_kwh.toFixed(4) + ' kWh' : '-'}`;
Â  Â  Â  Â  document.getElementById('stat-records').textContent = stats.total_records;
Â  Â  Â  Â  
Â  Â  Â  Â  elements.statisticsPanel.classList.remove('hidden');
        elements.statisticsFilterPanel.classList.remove('hidden'); // Show filter when stats are shown
Â  Â  Â  Â  showNotification('Statistik berhasil dimuat');
        updateDataInfo(); // Update info for statistics
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showNotification('Gagal mengambil statistik', 'error');
        elements.statisticsPanel.classList.add('hidden'); // Hide stats if failed
        elements.statisticsFilterPanel.classList.add('hidden'); // Hide filter if failed
Â  Â  Â  } finally {
Â  Â  Â  Â  hideLoading();
Â  Â  Â  }
Â  Â  }

Â  Â  // Export CSV (only for latest data as per requirements)
Â  Â  function exportCSV() {
Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if (!state.currentLatestData) {
Â  Â  Â  Â  showNotification('Tidak ada data terbaru untuk diekspor', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  let url = '/api/export-csv?mac=' + encodeURIComponent(state.selectedMac) + '&latest=true'; // Always request latest
Â  Â  Â  
Â  Â  Â  showLoading();
Â  Â  Â  
Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  link.href = url;
Â  Â  Â  link.download = `energy_latest_data_${state.selectedMac.replace(/:/g, '')}_${new Date().toISOString().split('T')[0]}.csv`;
Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  link.click();
Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  
Â  Â  Â  hideLoading();
Â  Â  Â  showNotification('File CSV data terbaru berhasil diunduh');
Â  Â  }

Â  Â  // Fetch relay status
Â  Â  async function fetchRelayStatus() {
Â  Â  Â  if (!state.selectedMac) return;

Â  Â  Â  try {
Â  Â  Â  Â  const response = await apiCall('/api/relay-status?mac=' + encodeURIComponent(state.selectedMac));
Â  Â  Â  Â  const status = response.status;
Â  Â  Â  Â  elements.relayStatus.textContent = status;
Â  Â  Â  Â  
Â  Â  Â  Â  if (status === 'ON') {
Â  Â  Â  Â  Â  elements.relayStatus.className = 'px-3 py-1 rounded-full text-white font-bold bg-green-600';
Â  Â  Â  Â  } else if (status === 'OFF') {
Â  Â  Â  Â  Â  elements.relayStatus.className = 'px-3 py-1 rounded-full text-white font-bold bg-red-600';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  elements.relayStatus.className = 'px-3 py-1 rounded-full text-white font-bold bg-gray-500';
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Gagal mengambil status relay:', error);
Â  Â  Â  }
Â  Â  }

Â  Â  // Fetch relay history
Â  Â  async function fetchRelayHistory() {
Â  Â  Â  if (!state.selectedMac) return;

Â  Â  Â  try {
Â  Â  Â  Â  const history = await apiCall('/api/relay-history?mac=' + encodeURIComponent(state.selectedMac));
Â  Â  Â  Â  elements.relayHistory.innerHTML = '';

Â  Â  Â  Â  if (history.length === 0) {
Â  Â  Â  Â  Â  elements.relayHistory.innerHTML = '<tr><td colspan="2" class="text-center py-2 text-gray-500">Tidak ada riwayat</td></tr>';
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const fragment = document.createDocumentFragment();
Â  Â  Â  Â  history.forEach(item => {
Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  const timestamp = item.timestamp || `${item.tanggal} ${item.waktu}`;
Â  Â  Â  Â  Â  const statusClass = item.relay_status === 'ON' ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  Â  <td class="py-1 px-3 text-xs">${timestamp}</td>
Â  Â  Â  Â  Â  Â  <td class="py-1 px-3 ${statusClass}">${item.relay_status}</td>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  fragment.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  Â  elements.relayHistory.appendChild(fragment);
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Gagal mengambil riwayat relay:', error);
Â  Â  Â  }
Â  Â  }

Â  Â  // Control relay
Â  Â  async function controlRelay(status) {
Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  showLoading();
Â  Â  Â  try {
Â  Â  Â  Â  await apiCall('/api/relay-control', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  mac_address: state.selectedMac,
Â  Â  Â  Â  Â  Â  status: status
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  showNotification(`Relay berhasil di${status === 'ON' ? 'nyalakan' : 'matikan'}`);
Â  Â  Â  Â  await fetchRelayStatus();
Â  Â  Â  Â  await fetchRelayHistory();
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showNotification('Gagal mengontrol relay', 'error');
Â  Â  Â  } finally {
Â  Â  Â  Â  hideLoading();
Â  Â  Â  }
Â  Â  }

Â  Â  // Setup auto refresh
Â  Â  function setupAutoRefresh() {
Â  Â  Â  clearAllIntervals();
Â  Â  Â  
Â  Â  Â  if (state.selectedMac) {
Â  Â  Â  Â  // Auto refresh data terbaru setiap 30 detik
Â  Â  Â  Â  state.intervals.dataRefresh = setInterval(() => {
Â  Â  Â  Â  Â  if (state.selectedMac && !state.isLoading) { // Always refresh latest data
Â  Â  Â  Â  Â  Â  fetchLatestData();
Â  Â  Â  Â  Â  Â  fetchRelayStatus();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 30000);

Â  Â  Â  Â  // Auto refresh riwayat relay setiap 15 detik
Â  Â  Â  Â  state.intervals.relayRefresh = setInterval(() => {
Â  Â  Â  Â  Â  if (state.selectedMac && !state.isLoading) {
Â  Â  Â  Â  Â  Â  fetchRelayHistory();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 15000);
Â  Â  Â  }
Â  Â  }

    // Toggle statistics view
    function toggleStatisticsView(show) {
        state.isStatisticsView = show;
        if (show) {
            elements.statisticsPanel.classList.remove('hidden');
            elements.statisticsFilterPanel.classList.remove('hidden');
            elements.btnShowStatistics.classList.add('hidden');
            elements.btnHideStatistics.classList.remove('hidden');
            fetchStatistics(); // Fetch stats when shown
        } else {
            elements.statisticsPanel.classList.add('hidden');
            elements.statisticsFilterPanel.classList.add('hidden');
            elements.btnShowStatistics.classList.remove('hidden');
            elements.btnHideStatistics.classList.add('hidden');
            updateDataInfo(); // Reset info display to latest data
        }
    }


Â  Â  // Event listeners setup
Â  Â  function setupEventListeners() {
Â  Â  Â  // MAC select change
Â  Â  Â  elements.macSelect.addEventListener('change', async (e) => {
Â  Â  Â  Â  state.selectedMac = e.target.value;
Â  Â  Â  Â  
Â  Â  Â  Â  clearAllIntervals();
Â  Â  Â  Â  
Â  Â  Â  Â  if (state.selectedMac) {
Â  Â  Â  Â  Â  elements.relayPanel.classList.remove('hidden');
Â  Â  Â  Â  Â  elements.latestDataTableContainer.classList.remove('hidden'); // Ensure latest data table is visible
            toggleStatisticsView(false); // Hide stats by default when new MAC selected

Â  Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  fetchLatestData(),
Â  Â  Â  Â  Â  Â  fetchRelayStatus(),
Â  Â  Â  Â  Â  Â  fetchRelayHistory()
Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  setupAutoRefresh();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  elements.relayPanel.classList.add('hidden');
            elements.statisticsPanel.classList.add('hidden');
            elements.statisticsFilterPanel.classList.add('hidden');
            elements.btnShowStatistics.classList.remove('hidden');
            elements.btnHideStatistics.classList.add('hidden');

Â  Â  Â  Â  Â  elements.latestDataTableBody.innerHTML = ''; // Clear latest data table
Â  Â  Â  Â  Â  state.currentLatestData = null;
Â  Â  Â  Â  Â  updateDataInfo();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Relay control buttons
Â  Â  Â  elements.btnOn.addEventListener('click', () => controlRelay('ON'));
Â  Â  Â  elements.btnOff.addEventListener('click', () => controlRelay('OFF'));

Â  Â  Â  // Statistics filter buttons
Â  Â  Â  elements.btnApplyStatisticsFilter.addEventListener('click', () => {
Â  Â  Â  Â  if (!elements.startDate.value || !elements.endDate.value) {
Â  Â  Â  Â  Â  showNotification('Pilih tanggal mulai dan akhir untuk statistik', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if (new Date(elements.startDate.value) > new Date(elements.endDate.value)) {
Â  Â  Â  Â  Â  showNotification('Tanggal mulai tidak boleh lebih besar dari tanggal akhir', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  fetchStatistics(); // Re-fetch statistics with new filter
Â  Â  Â  });

Â  Â  Â  elements.btnClearStatisticsFilter.addEventListener('click', () => {
Â  Â  Â  Â  setDefaultDatesForStatistics(); // Reset to default (last 7 days)
Â  Â  Â  Â  if (state.selectedMac) {
Â  Â  Â  Â  Â  fetchStatistics(); // Reload statistics with default dates
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Action buttons
Â  Â  Â  elements.btnExportCsv.addEventListener('click', exportCSV);
Â  Â  Â  
Â  Â  Â  // Toggle statistics view buttons
Â  Â  Â  elements.btnShowStatistics.addEventListener('click', () => {
Â  Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  Â  showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
        toggleStatisticsView(true);
Â  Â  Â  });

Â  Â  Â  elements.btnHideStatistics.addEventListener('click', () => {
Â  Â  Â  Â  toggleStatisticsView(false);
Â  Â  Â  });


Â  Â  Â  // Reset relay button
Â  Â  Â  elements.btnResetRelay.addEventListener('click', async () => {
Â  Â  Â  Â  if (confirm('Yakin ingin menghapus semua data riwayat relay?')) {
Â  Â  Â  Â  Â  showLoading();
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await apiCall('/api/reset-relay-data');
Â  Â  Â  Â  Â  Â  showNotification('Data relay berhasil direset');
Â  Â  Â  Â  Â  Â  if (state.selectedMac) {
Â  Â  Â  Â  Â  Â  Â  await fetchRelayHistory();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  showNotification('Gagal reset data relay', 'error');
Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // Initialize app
Â  Â  async function init() {
Â  Â  Â  setDefaultDatesForStatistics(); // Set default dates for statistics filter
Â  Â  Â  updateDataInfo(); // Initial info state (will be "latest data")
Â  Â  Â  setupEventListeners();
Â  Â  Â  
Â  Â  Â  try {
Â  Â  Â  Â  await fetchMacList();
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showNotification('Gagal memuat aplikasi', 'error');
Â  Â  Â  }
Â  Â  }

Â  Â  // Cleanup on page unload
Â  Â  window.addEventListener('beforeunload', () => {
Â  Â  Â  clearAllIntervals();
Â  Â  });

Â  Â  // Start the app
Â  Â  init();
Â  </script>
</body>
</html>
