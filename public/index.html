<!DOCTYPE html>
<html lang="id">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Smart Home Control Panel</title>
Â  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
Â <div class="container mx-auto p-6">
Â  Â  <h1 class="text-3xl font-bold mb-6 text-center text-blue-800">Smart Home Control Panel</h1>

Â  Â  <!-- Dropdown Pilih MAC Address -->
Â  Â  <div class="mb-6 text-center bg-white p-4 rounded-lg shadow-md">
Â  Â  Â  <label for="mac-select" class="font-semibold mr-2 text-lg">Pilih Perangkat:</label>
Â  Â  Â  <select id="mac-select" class="px-4 py-2 border rounded-lg text-lg min-w-64">
Â  Â  Â  Â  <option value="">-- Pilih MAC Address --</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <!-- Panel Kontrol Relay -->
Â  Â  <div id="relay-panel" class="mb-6 bg-white p-6 rounded-lg shadow-md hidden">
Â  Â  Â  <h2 class="text-xl font-bold mb-4 text-center text-green-700">Kontrol Relay</h2>
Â  Â  Â  
Â  Â  Â  <!-- Status Relay -->
Â  Â  Â  <div class="text-center mb-4">
Â  Â  Â  Â  <span class="text-lg font-semibold">Status: </span>
Â  Â  Â  Â  <span id="relay-status" class="px-3 py-1 rounded-full text-white font-bold">UNKNOWN</span>
Â  Â  Â  </div>

Â  Â  Â  <!-- Tombol Kontrol -->
Â  Â  Â  <div class="flex justify-center space-x-4 mb-4">
Â  Â  Â  Â  <button id="btn-on" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition transform hover:scale-105">
Â  Â  Â  Â  Â  ğŸ”Œ NYALAKAN
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button id="btn-off" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition transform hover:scale-105">
Â  Â  Â  Â  Â  ğŸ”Œ MATIKAN
Â  Â  Â  Â  </button>
Â  Â  Â  </div>

Â  Â  Â  <!-- Riwayat Kontrol Relay -->
Â  Â  Â  <div class="mt-6">
Â  Â  Â  Â  <h3 class="text-lg font-semibold mb-3 text-gray-700">Riwayat Status Relay (dari Perangkat)</h3>
Â  Â  Â  Â  <div class="max-h-40 overflow-y-auto">
Â  Â  Â  Â  Â  <table class="w-full text-sm">
Â  Â  Â  Â  Â  Â  <thead class="bg-gray-200">
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="py-2 px-3 text-left">Waktu</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="py-2 px-3 text-left">Status</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="relay-history" class="divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  Â  <!-- Riwayat akan ditampilkan di sini -->
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Filter Tanggal -->
Â  Â  <div class="mb-6 bg-white p-4 rounded-lg shadow-md">
Â  Â  Â  <h3 class="text-lg font-semibold mb-4 text-gray-700">Filter Data Berdasarkan Tanggal</h3>
Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai:</label>
Â  Â  Â  Â  Â  <input type="date" id="start-date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir:</label>
Â  Â  Â  Â  Â  <input type="date" id="end-date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <button id="btn-filter" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
Â  Â  Â  Â  Â  Â  ğŸ” Filter Data
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <button id="btn-clear-filter" class="w-full px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">
Â  Â  Â  Â  Â  Â  ğŸ—‘ Reset Filter
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Statistik Panel -->
Â  Â  <div id="statistics-panel" class="mb-6 bg-white p-6 rounded-lg shadow-md hidden">
Â  Â  Â  <h3 class="text-lg font-semibold mb-4 text-gray-700">Statistik Konsumsi Energi</h3>
Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
Â  Â  Â  Â  <div class="bg-blue-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-blue-800">Tegangan Rata-rata</h4>
Â  Â  Â  Â  Â  <p id="stat-voltage" class="text-2xl font-bold text-blue-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-green-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-green-800">Arus Rata-rata</h4>
Â  Â  Â  Â  Â  <p id="stat-current" class="text-2xl font-bold text-green-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-yellow-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-yellow-800">Daya Rata-rata</h4>
Â  Â  Â  Â  Â  <p id="stat-power" class="text-2xl font-bold text-yellow-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-purple-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-purple-800">Total Daya</h4>
Â  Â  Â  Â  Â  <p id="stat-total-power" class="text-2xl font-bold text-purple-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-red-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-red-800">Konsumsi KWh</h4>
Â  Â  Â  Â  Â  <p id="stat-consumption" class="text-2xl font-bold text-red-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-gray-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  <h4 class="font-semibold text-gray-800">Total Record</h4>
Â  Â  Â  Â  Â  <p id="stat-records" class="text-2xl font-bold text-gray-600">-</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Tombol Reset dan Export -->
Â  Â  <div class="text-center mb-6 flex flex-wrap justify-center gap-4">
Â  Â  Â  <button id="btn-statistics" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
Â  Â  Â  Â  ğŸ“Š Lihat Statistik
Â  Â  Â  </button>
Â  Â  Â  <button id="btn-latest-data" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
Â  Â  Â  Â  ğŸ”„ Data Terbaru
Â  Â  Â  </button>
Â  Â  Â  <button onclick="if(confirm('Yakin ingin menghapus semua data energi?')) window.location.href='/api/reset-data'" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">
Â  Â  Â  Â  ğŸ—‘ Reset Data Energi
Â  Â  Â  </button>
Â  Â  Â  <button id="btn-reset-relay" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition">
Â  Â  Â  Â  ğŸ—‘ Reset Data Relay
Â  Â  Â  </button>
Â  Â  Â  <button id="btn-export-csv" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
Â  Â  Â  Â  ğŸ“„ Export CSV
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <!-- Informasi Data -->
Â  Â  <div class="mb-4 bg-blue-50 p-3 rounded-lg">
Â  Â  Â  <div class="flex flex-wrap justify-between items-center text-sm text-blue-800">
Â  Â  Â  Â  <span id="data-info">Menampilkan data terbaru</span>
Â  Â  Â  Â  <span id="total-records" class="font-semibold"></span>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Tabel Data Konsumsi Energi -->
Â  Â  <div class="bg-white rounded-lg shadow-md overflow-hidden">
Â  Â  Â  <h2 class="text-xl font-bold p-4 bg-blue-600 text-white">Data Konsumsi Energi</h2>
Â  Â  Â  <div class="overflow-x-auto">
Â  Â  Â  Â  <table class="min-w-full">
Â  Â  Â  Â  Â  <thead class="bg-blue-500 text-white">
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">ID</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Tanggal</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Waktu</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Tegangan (V)</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Arus (A)</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Daya (W)</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">KWh</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">MAC Address</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">Status Relay</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-4 text-left">MQTT Topic</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="data-table" class="divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  <!-- Data akan ditampilkan di sini -->
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Loading dan Status -->
Â  Â  <div id="loading" class="hidden fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg">
Â  Â  Â  Memproses...
Â  Â  </div>
Â  Â  
Â  Â  <div id="notification" class="hidden fixed top-4 right-4 px-4 py-2 rounded-lg text-white font-semibold">
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // App state dengan proteksi
Â  Â  const state = {
Â  Â  Â  _selectedMac: '',
Â  Â  Â  _currentData: [],
Â  Â  Â  _isProcessing: false,
Â  Â  Â  _intervals: {},
Â  Â  Â  get selectedMac() {
Â  Â  Â  Â  return this._selectedMac;
Â  Â  Â  },
Â  Â  Â  set selectedMac(value) {
Â  Â  Â  Â  this._selectedMac = value;
Â  Â  Â  Â  // Panggil setupAutoRefresh di sini saat selectedMac berubah
Â  Â  Â  Â  this.setupAutoRefresh(); 
Â  Â  Â  },
Â  Â  Â  get currentData() {
Â  Â  Â  Â  return this._currentData;
Â  Â  Â  },
Â  Â  Â  set currentData(value) {
Â  Â  Â  Â  this._currentData = Array.isArray(value) ? value : [];
Â  Â  Â  },
Â  Â  Â  get isProcessing() {
Â  Â  Â  Â  return this._isProcessing;
Â  Â  Â  },
Â  Â  Â  set isProcessing(value) {
Â  Â  Â  Â  this._isProcessing = Boolean(value);
Â  Â  Â  Â  const loadingElement = document.getElementById('loading');
Â  Â  Â  Â  if (loadingElement) { // Pastikan elemen ada
Â  Â  Â  Â  Â  if (this._isProcessing) {
Â  Â  Â  Â  Â  Â  loadingElement.classList.remove('hidden');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  loadingElement.classList.add('hidden');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  // Tambahkan method setupAutoRefresh di sini, di dalam objek state
Â  Â  Â  setupAutoRefresh() {
Â  Â  Â  Â  // Clear all previous intervals
Â  Â  Â  Â  Object.values(this._intervals).forEach(interval => clearInterval(interval));
Â  Â  Â  Â  this._intervals = {};

Â  Â  Â  Â  if (this._selectedMac) {
Â  Â  Â  Â  Â  // Auto refresh data setiap 30 detik (hanya jika tidak ada filter tanggal)
Â  Â  Â  Â  Â  this._intervals.dataRefresh = setInterval(() => {
Â  Â  Â  Â  Â  Â  if (this._selectedMac && !document.getElementById('start-date').value && 
Â  Â  Â  Â  Â  Â  Â  Â  !document.getElementById('end-date').value && !this.isProcessing) {
Â  Â  Â  Â  Â  Â  Â  uiController.loadEnergyData(); // Panggil dari uiController
Â  Â  Â  Â  Â  Â  Â  uiController.loadRelayStatus();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }, 30000);

Â  Â  Â  Â  Â  // Auto refresh riwayat setiap 15 detik
Â  Â  Â  Â  Â  this._intervals.relayRefresh = setInterval(() => {
Â  Â  Â  Â  Â  Â  if (this._selectedMac && !this.isProcessing) {
Â  Â  Â  Â  Â  Â  Â  uiController.loadRelayHistory(); // Panggil dari uiController
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }, 15000);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };

Â  Â  // DOM elements
Â  Â  const elements = {
Â  Â  Â  macSelect: document.getElementById('mac-select'),
Â  Â  Â  tableBody: document.getElementById('data-table'),
Â  Â  Â  relayPanel: document.getElementById('relay-panel'),
Â  Â  Â  relayStatus: document.getElementById('relay-status'),
Â  Â  Â  btnOn: document.getElementById('btn-on'),
Â  Â  Â  btnOff: document.getElementById('btn-off'),
Â  Â  Â  relayHistory: document.getElementById('relay-history'),
Â  Â  Â  btnResetRelay: document.getElementById('btn-reset-relay'),
Â  Â  Â  loading: document.getElementById('loading'),
Â  Â  Â  notification: document.getElementById('notification'),
Â  Â  Â  statisticsPanel: document.getElementById('statistics-panel'),
Â  Â  Â  startDate: document.getElementById('start-date'),
Â  Â  Â  endDate: document.getElementById('end-date'),
Â  Â  Â  btnFilter: document.getElementById('btn-filter'),
Â  Â  Â  btnClearFilter: document.getElementById('btn-clear-filter'),
Â  Â  Â  btnExportCsv: document.getElementById('btn-export-csv'),
Â  Â  Â  btnStatistics: document.getElementById('btn-statistics'),
Â  Â  Â  btnLatestData: document.getElementById('btn-latest-data'),
Â  Â  Â  dataInfo: document.getElementById('data-info'),
Â  Â  Â  totalRecords: document.getElementById('total-records')
Â  Â  };

Â  Â  // Utility functions dengan error handling
Â  Â  const utils = {
Â  Â  Â  showNotification: (message, type = 'success') => {
Â  Â  Â  Â  const notification = document.getElementById('notification');
Â  Â  Â  Â  notification.textContent = message;
Â  Â  Â  Â  notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white font-semibold ${
Â  Â  Â  Â  Â  type === 'success' ? 'bg-green-600' : 'bg-red-600'
Â  Â  Â  Â  }`;
Â  Â  Â  Â  notification.classList.remove('hidden');
Â  Â  Â  Â  
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  notification.classList.add('hidden');
Â  Â  Â  Â  }, 3000);
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  safeParseFloat: (value) => {
Â  Â  Â  Â  const num = parseFloat(value);
Â  Â  Â  Â  return isNaN(num) ? 0 : num;
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  formatDate: (dateString) => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  return new Date(dateString).toISOString().split('T')[0];
Â  Â  Â  Â  } catch {
Â  Â  Â  Â  Â  return '';
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };

Â  Â  // API Service dengan queue dan timeout
Â  Â  const apiService = {
Â  Â  Â  queue: [],
Â  Â  Â  activeRequests: 0,
Â  Â  Â  maxConcurrent: 2,
Â  Â  Â  
Â  Â  Â  async request(url, config = {}) {
Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  const task = async () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const response = await axios({
Â  Â  Â  Â  Â  Â  Â  Â  url,
Â  Â  Â  Â  Â  Â  Â  Â  timeout: 8000,
Â  Â  Â  Â  Â  Â  Â  Â  ...config
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  resolve(response.data);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  console.error('API Request Error:', error);
Â  Â  Â  Â  Â  Â  Â  utils.showNotification(`API Error: ${error.message || 'Unknown error'}`, 'error');
Â  Â  Â  Â  Â  Â  Â  reject(error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  // This ensures state.isProcessing is always false after a request
Â  Â  Â  Â  Â  Â  Â  // unless another request is immediately queued.
Â  Â  Â  Â  Â  Â  Â  if (apiService.activeRequests === 1 && apiService.queue.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  state.isProcessing = false;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  this.queue.push({ task, resolve, reject });
Â  Â  Â  Â  Â  this.processQueue();
Â  Â  Â  Â  });
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  processQueue() {
Â  Â  Â  Â  if (!state.isProcessing && this.queue.length > 0) {
Â  Â  Â  Â  Â  state.isProcessing = true; // Set to true when starting to process
Â  Â  Â  Â  }

Â  Â  Â  Â  while (this.activeRequests < this.maxConcurrent && this.queue.length > 0) {
Â  Â  Â  Â  Â  this.activeRequests++;
Â  Â  Â  Â  Â  const { task, resolve, reject } = this.queue.shift();
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  task()
Â  Â  Â  Â  Â  Â  .then(resolve)
Â  Â  Â  Â  Â  Â  .catch(reject)
Â  Â  Â  Â  Â  Â  .finally(() => {
Â  Â  Â  Â  Â  Â  Â  this.activeRequests--;
Â  Â  Â  Â  Â  Â  Â  // Ensure state.isProcessing is updated only after all requests are done
Â  Â  Â  Â  Â  Â  Â  if (this.activeRequests === 0 && this.queue.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  state.isProcessing = false;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  this.processQueue(); // Process next in queue
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  async getMacList() {
Â  Â  Â  Â  return this.request('/api/mac-list');
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  async getEnergyData(mac, startDate, endDate) {
Â  Â  Â  Â  const params = new URLSearchParams();
Â  Â  Â  Â  params.append('mac', mac);
Â  Â  Â  Â  if (startDate && endDate) {
Â  Â  Â  Â  Â  params.append('start_date', startDate);
Â  Â  Â  Â  Â  params.append('end_date', endDate);
Â  Â  Â  Â  }
Â  Â  Â  Â  return this.request(`/api/data?${params.toString()}`);
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  async getRelayStatus(mac) {
Â  Â  Â  Â  return this.request(`/api/relay-status?mac=${encodeURIComponent(mac)}`);
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  async getRelayHistory(mac) {
Â  Â  Â  Â  return this.request(`/api/relay-history?mac=${encodeURIComponent(mac)}`);
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  async controlRelay(mac, status) {
Â  Â  Â  Â  return this.request('/api/relay-control', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  data: { mac_address: mac, status }
Â  Â  Â  Â  });
Â  Â  Â  },

Â  Â  Â  async getStatistics(mac, startDate, endDate) {
Â  Â  Â  Â  const params = new URLSearchParams();
Â  Â  Â  Â  params.append('mac', mac);
Â  Â  Â  Â  if (startDate && endDate) {
Â  Â  Â  Â  Â  params.append('start_date', startDate);
Â  Â  Â  Â  Â  params.append('end_date', endDate);
Â  Â  Â  Â  }
Â  Â  Â  Â  return this.request(`/api/statistics?${params.toString()}`);
Â  Â  Â  },

Â  Â  Â  async exportCsv(mac, startDate, endDate) {
Â  Â  Â  Â  const params = new URLSearchParams();
Â  Â  Â  Â  params.append('mac', mac);
Â  Â  Â  Â  if (startDate && endDate) {
Â  Â  Â  Â  Â  params.append('start_date', startDate);
Â  Â  Â  Â  Â  params.append('end_date', endDate);
Â  Â  Â  Â  }
Â  Â  Â  Â  // Perhatikan: Axios tidak cocok untuk mengunduh file biner langsung seperti ini,
Â  Â  Â  Â  // karena responsnya sudah di-handle oleh browser via link.href.
Â  Â  Â  Â  // Jadi, fungsi ini hanya akan membangun URL.
Â  Â  Â  Â  // Jika Anda ingin menggunakan Axios untuk download dan handle blob, perlu responseType: 'blob'
Â  Â  Â  Â  return `/api/export-csv?${params.toString()}`;
Â  Â  Â  }
Â  Â  };

Â  Â  // UI Controller dengan debounce dan throttling
Â  Â  const uiController = {
Â  Â  Â  init() {
Â  Â  Â  Â  this.setupEventListeners();
Â  Â  Â  Â  this.setDefaultDates();
Â  Â  Â  Â  this.loadMacList();
Â  Â  Â  Â  this.updateDataInfo(); // Panggil ini juga saat inisialisasi
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  setupEventListeners() {
Â  Â  Â  Â  // Dapatkan instance Lodash
Â  Â  Â  Â  const _ = window._; // Memastikan Lodash sudah dimuat

Â  Â  Â  Â  // Debounced event listeners
Â  Â  Â  Â  elements.macSelect.addEventListener('change', 
Â  Â  Â  Â  Â  _.debounce(this.handleMacSelect.bind(this), 300));
Â  Â  Â  Â  
Â  Â  Â  Â  elements.btnFilter.addEventListener('click', 
Â  Â  Â  Â  Â  _.throttle(this.handleFilterClick.bind(this), 1000));
Â  Â  Â  Â  
Â  Â  Â  Â  // Regular event listeners
Â  Â  Â  Â  elements.btnOn.addEventListener('click', 
Â  Â  Â  Â  Â  this.handleRelayOn.bind(this));
Â  Â  Â  Â  elements.btnOff.addEventListener('click', 
Â  Â  Â  Â  Â  this.handleRelayOff.bind(this));

Â  Â  Â  Â  elements.btnClearFilter.addEventListener('click', this.handleClearFilter.bind(this));
Â  Â  Â  Â  elements.btnExportCsv.addEventListener('click', this.handleExportCsv.bind(this));
Â  Â  Â  Â  elements.btnStatistics.addEventListener('click', this.handleStatistics.bind(this));
Â  Â  Â  Â  elements.btnLatestData.addEventListener('click', this.handleLatestData.bind(this));
Â  Â  Â  Â  elements.btnResetRelay.addEventListener('click', this.handleResetRelay.bind(this));

Â  Â  Â  Â  // Cleanup on page unload
Â  Â  Â  Â  window.addEventListener('beforeunload', this.cleanup.bind(this));
Â  Â  Â  },
Â  Â  Â  
Â  Â  Â  // Set default dates (last 7 days)
Â  Â  Â  setDefaultDates() {
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  const weekAgo = new Date(today);
Â  Â  Â  Â  weekAgo.setDate(today.getDate() - 7);
Â  Â  Â  Â  
Â  Â  Â  Â  elements.endDate.value = today.toISOString().split('T')[0];
Â  Â  Â  Â  elements.startDate.value = weekAgo.toISOString().split('T')[0];
Â  Â  Â  },

Â  Â  Â  // Update info data (sudah diperbaiki template literalnya)
Â  Â  Â  updateDataInfo() {
Â  Â  Â  Â  const startDateVal = elements.startDate.value;
Â  Â  Â  Â  const endDateVal = elements.endDate.value;
Â  Â  Â  Â  
Â  Â  Â  Â  if (startDateVal && endDateVal) {
Â  Â  Â  Â  Â  elements.dataInfo.textContent = `Menampilkan data dari ${startDateVal} sampai ${endDateVal}`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  elements.dataInfo.textContent = 'Menampilkan data terbaru (20 record terakhir)';
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  elements.totalRecords.textContent = `Total: ${state.currentData.length} record`;
Â  Â  Â  },

Â  Â  Â  async loadMacList() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const macs = await apiService.getMacList();
Â  Â  Â  Â  Â  elements.macSelect.innerHTML = '<option value="">-- Pilih MAC Address --</option>';
Â  Â  Â  Â  Â  macs.forEach(mac => {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = mac.mac_address;
Â  Â  Â  Â  Â  Â  option.textContent = `ğŸ“± ${mac.mac_address}`;
Â  Â  Â  Â  Â  Â  elements.macSelect.appendChild(option);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('Gagal mengambil daftar perangkat:', error);
Â  Â  Â  Â  Â  utils.showNotification('Gagal mengambil daftar perangkat', 'error');
Â  Â  Â  Â  }
Â  Â  Â  },

Â  Â  Â  async handleFilterClick() {
Â  Â  Â  Â  if (!elements.startDate.value || !elements.endDate.value) {
Â  Â  Â  Â  Â  utils.showNotification('Pilih tanggal mulai dan akhir', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if (new Date(elements.startDate.value) > new Date(elements.endDate.value)) {
Â  Â  Â  Â  Â  utils.showNotification('Tanggal mulai tidak boleh lebih besar dari tanggal akhir', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  this.loadEnergyData();
Â  Â  Â  },

Â  Â  Â  async handleClearFilter() {
Â  Â  Â  Â  elements.startDate.value = '';
Â  Â  Â  Â  elements.endDate.value = '';
Â  Â  Â  Â  elements.statisticsPanel.classList.add('hidden');
Â  Â  Â  Â  if (state.selectedMac) {
Â  Â  Â  Â  Â  this.loadEnergyData();
Â  Â  Â  Â  }
Â  Â  Â  Â  this.updateDataInfo();
Â  Â  Â  },

Â  Â  Â  async loadRelayStatus() {
Â  Â  Â  Â  if (!state.selectedMac) return;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const response = await apiService.getRelayStatus(state.selectedMac);
Â  Â  Â  Â  Â  const status = response.status;
Â  Â  Â  Â  Â  elements.relayStatus.textContent = status;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (status === 'ON') {
Â  Â  Â  Â  Â  Â  elements.relayStatus.className = 'px-3 py-1 rounded-full text-white font-bold bg-green-600';
Â  Â  Â  Â  Â  } else if (status === 'OFF') {
Â  Â  Â  Â  Â  Â  elements.relayStatus.className = 'px-3 py-1 rounded-full text-white font-bold bg-red-600';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  elements.relayStatus.className = 'px-3 py-1 rounded-full text-white font-bold bg-gray-500';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('Gagal mengambil status relay:', error);
Â  Â  Â  Â  Â  // Notifikasi tidak perlu di sini karena ini auto-refresh, bisa mengganggu
Â  Â  Â  Â  }
Â  Â  Â  },

Â  Â  Â  async loadRelayHistory() {
Â  Â  Â  Â  if (!state.selectedMac) return;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const history = await apiService.getRelayHistory(state.selectedMac);
Â  Â  Â  Â  Â  elements.relayHistory.innerHTML = '';

Â  Â  Â  Â  Â  if (history.length === 0) {
Â  Â  Â  Â  Â  Â  elements.relayHistory.innerHTML = '<tr><td colspan="2" class="text-center py-2 text-gray-500">Tidak ada riwayat</td></tr>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const fragment = document.createDocumentFragment();
Â  Â  Â  Â  Â  history.forEach(item => {
Â  Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  // Pastikan item.timestamp sudah diformat di backend, atau format di sini
Â  Â  Â  Â  Â  Â  const timestamp = item.timestamp || `${item.tanggal} ${item.waktu}`; // Perbaikan template literal
Â  Â  Â  Â  Â  Â  const statusClass = item.relay_status === 'ON' ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <td class="py-1 px-3 text-xs">${timestamp}</td>
Â  Â  Â  Â  Â  Â  Â  <td class="py-1 px-3 ${statusClass}">${item.relay_status}</td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  fragment.appendChild(tr);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  elements.relayHistory.appendChild(fragment);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('Gagal mengambil riwayat relay:', error);
Â  Â  Â  Â  }
Â  Â  Â  },

Â  Â  Â  async handleRelayOn() {
Â  Â  Â  Â  await this.controlRelay('ON');
Â  Â  Â  },
Â  Â  Â  async handleRelayOff() {
Â  Â  Â  Â  await this.controlRelay('OFF');
Â  Â  Â  },

Â  Â  Â  async controlRelay(status) {
Â  Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  Â  utils.showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  await apiService.controlRelay(state.selectedMac, status);
Â  Â  Â  Â  Â  utils.showNotification(`Relay berhasil di${status === 'ON' ? 'nyalakan' : 'matikan'}`); // Perbaikan template literal
Â  Â  Â  Â  Â  // Segera refresh status dan history
Â  Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  this.loadRelayStatus(),
Â  Â  Â  Â  Â  Â  this.loadRelayHistory()
Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  utils.showNotification('Gagal mengontrol relay', 'error');
Â  Â  Â  Â  }
Â  Â  Â  },

Â  Â  Â  async handleStatistics() {
Â  Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  Â  utils.showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const startDate = elements.startDate.value;
Â  Â  Â  Â  const endDate = elements.endDate.value;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const data = await apiService.getStatistics(state.selectedMac, startDate, endDate);
Â  Â  Â  Â  Â  const stats = data.statistics;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  document.getElementById('stat-voltage').textContent = `${utils.safeParseFloat(stats.average_voltage)} V`;
Â  Â  Â  Â  Â  document.getElementById('stat-current').textContent = `${utils.safeParseFloat(stats.average_current)} A`;
Â  Â  Â  Â  Â  document.getElementById('stat-power').textContent = `${utils.safeParseFloat(stats.average_power)} W`;
Â  Â  Â  Â  Â  document.getElementById('stat-total-power').textContent = `${utils.safeParseFloat(stats.total_power)} W`;
Â  Â  Â  Â  Â  document.getElementById('stat-consumption').textContent = `${utils.safeParseFloat(stats.energy_range.consumption_kwh)} kWh`;
Â  Â  Â  Â  Â  document.getElementById('stat-records').textContent = stats.total_records;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  elements.statisticsPanel.classList.remove('hidden');
Â  Â  Â  Â  Â  utils.showNotification('Statistik berhasil dimuat');
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  utils.showNotification('Gagal mengambil statistik', 'error');
Â  Â  Â  Â  }
Â  Â  Â  },

Â  Â  Â  async handleLatestData() {
Â  Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  Â  utils.showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const data = await apiService.request('/api/latest-data?mac=' + encodeURIComponent(state.selectedMac));
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (Object.keys(data).length === 0) {
Â  Â  Â  Â  Â  Â  utils.showNotification('Tidak ada data terbaru untuk perangkat ini', 'error');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  state.currentData = [data];
Â  Â  Â  Â  Â  this.renderTable([data]);
Â  Â  Â  Â  Â  elements.dataInfo.textContent = 'Menampilkan data terbaru';
Â  Â  Â  Â  Â  elements.totalRecords.textContent = 'Total: 1 record (terbaru)';
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  utils.showNotification('Data terbaru berhasil dimuat');
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  utils.showNotification('Gagal mengambil data terbaru', 'error');
Â  Â  Â  Â  }
Â  Â  Â  },

Â  Â  Â  async handleExportCsv() {
Â  Â  Â  Â  if (!state.selectedMac) {
Â  Â  Â  Â  Â  utils.showNotification('Pilih perangkat terlebih dahulu', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (state.currentData.length === 0) {
Â  Â  Â  Â  Â  utils.showNotification('Tidak ada data untuk diekspor', 'error');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const startDate = elements.startDate.value;
Â  Â  Â  Â  const endDate = elements.endDate.value;

Â  Â  Â  Â  // apiService.exportCsv hanya mengembalikan URL, bukan melakukan request Axios
Â  Â  Â  Â  const urlToDownload = await apiService.exportCsv(state.selectedMac, startDate, endDate);
Â  Â  Â  Â  
Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  link.href = urlToDownload;
Â  Â  Â  Â  link.download = `energy_data_${state.selectedMac.replace(/:/g, '')}_${startDate || 'all'}_${endDate || 'all'}.csv`; // Perbaikan nama file
Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  link.click();
Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  
Â  Â  Â  Â  utils.showNotification('File CSV berhasil diunduh');
Â  Â  Â  },

Â  Â  Â  async handleResetRelay() {
Â  Â  Â  Â  if (confirm('Yakin ingin menghapus semua data riwayat relay?')) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await apiService.request('/api/reset-relay-data');
Â  Â  Â  Â  Â  Â  utils.showNotification('Data relay berhasil direset');
Â  Â  Â  Â  Â  Â  if (state.selectedMac) {
Â  Â  Â  Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  this.loadRelayHistory(),
Â  Â  Â  Â  Â  Â  Â  Â  this.loadEnergyData()
Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  utils.showNotification('Gagal reset data relay', 'error');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  },

Â  Â  Â  // ... (lanjutkan dengan fungsi lainnya)
Â  Â  };

Â  Â  // Initialize the app
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  uiController.init();
Â  Â  });
Â  </script>
</body>
</html>
